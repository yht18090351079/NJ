<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>注册 - 农产品供销信息平台</title>
    <!-- 引入字体图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- 引入自定义样式 -->
    <link rel="stylesheet" href="css/style.css">
    <!-- 页面描述 -->
    <meta name="description" content="注册农产品供销信息平台，连接农产品生产者与采购商的桥梁">
    <!-- 主题色 -->
    <meta name="theme-color" content="#2E8B57">
    <style>
        /* 注册页面特有样式 */
        body {
            background-color: #f5f5f5;
        }

        .register-container {
            padding: var(--spacing-xl);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .register-header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
            margin-top: var(--spacing-md);
        }

        .register-logo {
            width: 80px;
            height: 80px;
            margin-bottom: var(--spacing-sm);
        }

        .register-title {
            font-size: var(--font-size-lg);
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .register-subtitle {
            font-size: var(--font-size-sm);
            color: var(--text-tertiary);
        }

        .register-form {
            background-color: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-xl);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: var(--font-size-sm);
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .input-wrapper {
            position: relative;
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) 40px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            color: var(--text-primary);
        }

        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(46, 139, 87, 0.2);
            outline: none;
        }

        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            cursor: pointer;
        }

        .verification-code {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .get-code-btn {
            background-color: #f5f5f5;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            white-space: nowrap;
        }

        .role-selector {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-top: var(--spacing-xs);
        }

        .role-option {
            flex: 1;
            text-align: center;
            padding: var(--spacing-md) 0;
            color: var(--text-secondary);
            font-size: var(--font-size-base);
            cursor: pointer;
            transition: all 0.3s;
        }

        .role-option.active {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .agreement {
            display: flex;
            align-items: flex-start;
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .agreement input {
            margin-right: var(--spacing-sm);
            margin-top: 4px;
        }

        .agreement a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .register-btn {
            display: block;
            width: 100%;
            padding: var(--spacing-md) 0;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .register-btn:hover {
            background-color: #1b7d48;
        }

        .login-link {
            text-align: center;
            margin-top: var(--spacing-md);
            font-size: var(--font-size-sm);
        }

        .login-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
        }

        .footer-text {
            text-align: center;
            margin-top: auto;
            padding: var(--spacing-md) 0;
            color: var(--text-tertiary);
            font-size: var(--font-size-xs);
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-xl);
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 14px;
            left: 24px;
            right: 24px;
            height: 2px;
            background-color: var(--border-color);
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f5f5f5;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
            font-weight: bold;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .step-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .step.active .step-number {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--white);
        }

        .step.active .step-label {
            color: var(--primary-color);
            font-weight: bold;
        }

        .step.completed .step-number {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--white);
        }

        .company-info {
            display: none;
        }
    </style>
</head>

<body>
    <!-- 主容器 -->
    <div class="mobile-frame-container">
        <!-- 页面内容区域 -->
        <div class="page-content">
            <!-- 顶部导航栏 -->
            <header class="top-navbar">
                <div class="container flex-between">
                    <!-- 返回按钮 -->
                    <a href="javascript:history.back()">
                        <i class="fas fa-arrow-left"></i>
                    </a>

                    <!-- 标题 -->
                    <h1>注册账号</h1>

                    <!-- 右侧空白占位 -->
                    <div style="width: 24px;"></div>
                </div>
            </header>

            <!-- 主要内容区 -->
            <main class="main-content">
                <div class="register-container">
                    <!-- 返回按钮 -->
                    <a href="login.html"
                        style="position: absolute; top: 20px; left: 20px; color: var(--text-secondary);">
                        <i class="fas fa-arrow-left" style="font-size: 20px;"></i>
                    </a>

                    <div class="register-header">
                        <img src="https://img.icons8.com/color/240/null/natural-food.png" alt="农产品供销信息平台"
                            class="register-logo" width="240" height="240">
                        <h1 class="register-title">创建新账号</h1>
                        <p class="register-subtitle">加入农产品供销信息平台</p>
                    </div>

                    <!-- 步骤指示器 -->
                    <div class="step-indicator">
                        <div class="step active">
                            <div class="step-number">1</div>
                            <div class="step-label">基本信息</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-label">身份验证</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-label">完成注册</div>
                        </div>
                    </div>

                    <div class="register-form">
                        <!-- 步骤1：基本信息 -->
                        <form id="registerForm">
                            <button type="button" id="testFillBtn" style="
                                background-color: #f0f0f0;
                                color: #666;
                                border: 1px dashed #ccc;
                                padding: 8px 16px;
                                border-radius: 4px;
                                margin-bottom: 20px;
                                cursor: pointer;
                                width: 100%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-magic"></i>
                                <span>测试填充，开发请删除</span>
                            </button>

                            <div class="form-group">
                                <label class="form-label">用户名</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-user input-icon"></i>
                                    <input type="text" class="form-input" id="username" placeholder="请输入用户名" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">手机号</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-mobile-alt input-icon"></i>
                                    <input type="tel" class="form-input" placeholder="请输入手机号码" required
                                        pattern="1[3-9]\d{9}">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">验证码</label>
                                <div class="verification-code">
                                    <div class="input-wrapper" style="flex-grow: 1;">
                                        <i class="fas fa-shield-alt input-icon"></i>
                                        <input type="text" class="form-input" placeholder="请输入验证码" required
                                            pattern="\d{6}">
                                    </div>
                                    <button type="button" class="get-code-btn">获取验证码</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">设置密码</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-lock input-icon"></i>
                                    <input type="password" class="form-input" id="password" placeholder="请设置登录密码"
                                        required>
                                    <i class="fas fa-eye password-toggle" id="passwordToggle"></i>
                                </div>
                                <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 6px;">
                                    密码长度至少8位，包含数字和字母
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">确认密码</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-lock input-icon"></i>
                                    <input type="password" class="form-input" id="confirmPassword" placeholder="请再次输入密码"
                                        required>
                                </div>
                            </div>

                            <!-- 在角色选择之前添加身份验证字段 -->
                            <div class="form-group">
                                <button type="button" id="testFillIdentityBtn" style="
                                    background-color: #f0f0f0;
                                    color: #666;
                                    border: 1px dashed #ccc;
                                    padding: 8px 16px;
                                    border-radius: 4px;
                                    margin-bottom: 20px;
                                    cursor: pointer;
                                    width: 100%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-magic"></i>
                                    <span>测试填充身份信息</span>
                                </button>

                                <div class="form-group">
                                    <label class="form-label">真实姓名</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-user input-icon"></i>
                                        <input type="text" class="form-input" id="realName" placeholder="请输入真实姓名">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">身份证号码</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-id-card input-icon"></i>
                                        <input type="text" class="form-input" id="idCard" placeholder="请输入18位身份证号码"
                                            pattern="[1-9]\d{5}(18|19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[\dX]">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">用户角色（可多选）</label>
                                <div class="role-selector" id="roleSelector">
                                    <div class="role-option" data-role="supplier">
                                        <input type="checkbox" id="roleSupplier" name="role" value="supplier">
                                        <i class="fas fa-leaf"></i>
                                        <label for="roleSupplier">农产品供应商</label>
                                    </div>
                                    <div class="role-option" data-role="buyer">
                                        <input type="checkbox" id="roleBuyer" name="role" value="buyer">
                                        <i class="fas fa-shopping-cart"></i>
                                        <label for="roleBuyer">采购商</label>
                                    </div>
                                </div>
                                <div class="error-message"
                                    style="display: none; color: #f44336; font-size: 12px; margin-top: 4px;"></div>
                            </div>

                            <!-- 供应商特有的表单字段，根据角色选择显示/隐藏 -->
                            <div class="company-info supplier-info">
                                <div class="form-group">
                                    <label class="form-label">农场/企业名称</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-building input-icon"></i>
                                        <input type="text" class="form-input" placeholder="请输入农场或企业名称">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">主营产品类别</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-leaf input-icon"></i>
                                        <select class="form-input">
                                            <option value="">请选择主营产品类别</option>
                                            <option value="fruits">水果</option>
                                            <option value="vegetables">蔬菜</option>
                                            <option value="grains">粮食</option>
                                            <option value="meat">肉禽蛋</option>
                                            <option value="aquatic">水产</option>
                                            <option value="other">其他</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- 采购商特有的表单字段，根据角色选择显示/隐藏 -->
                            <div class="company-info buyer-info" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">企业名称</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-building input-icon"></i>
                                        <input type="text" class="form-input" placeholder="请输入企业名称">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">采购需求类别</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-shopping-basket input-icon"></i>
                                        <select class="form-input">
                                            <option value="">请选择采购需求类别</option>
                                            <option value="fruits">水果</option>
                                            <option value="vegetables">蔬菜</option>
                                            <option value="grains">粮食</option>
                                            <option value="meat">肉禽蛋</option>
                                            <option value="aquatic">水产</option>
                                            <option value="other">其他</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="agreement">
                                <input type="checkbox" id="agreement" required>
                                <label for="agreement">
                                    我已阅读并同意平台的<a href="javascript:void(0);">《用户协议》</a>和<a
                                        href="javascript:void(0);">《隐私政策》</a>，
                                    了解平台规则及<a href="javascript:void(0);">《禁售规则》</a>
                                </label>
                            </div>

                            <button type="submit" class="register-btn">注 册</button>

                            <div class="login-link">
                                已有账号? <a href="login.html">立即登录</a>
                            </div>
                        </form>
                    </div>

                    <div class="footer-text">
                        © 2023 农产品供销信息平台 版权所有
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 引入主JavaScript文件 -->
    <script src="js/main.js"></script>
    <!-- 引入认证管理脚本 -->
    <script src="js/auth.js"></script>
    <!-- 引入批注组件 -->
    <script src="js/annotation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 获取步骤指示器和表单元素
            const steps = document.querySelectorAll('.step');
            const registerForm = document.getElementById('registerForm');
            let currentStep = 0;

            // 创建并添加导航按钮
            const nextStepBtn = document.createElement('button');
            nextStepBtn.type = 'button';
            nextStepBtn.className = 'register-btn';
            nextStepBtn.textContent = '下一步';
            nextStepBtn.style.marginBottom = '16px';

            const prevStepBtn = document.createElement('button');
            prevStepBtn.type = 'button';
            prevStepBtn.textContent = '上一步';
            prevStepBtn.style.backgroundColor = '#f5f5f5';
            prevStepBtn.style.color = '#666';
            prevStepBtn.style.border = '1px solid #ddd';
            prevStepBtn.style.padding = '12px 0';
            prevStepBtn.style.width = '100%';
            prevStepBtn.style.borderRadius = '8px';
            prevStepBtn.style.marginBottom = '16px';
            prevStepBtn.style.display = 'none';

            // 将按钮添加到表单中
            const submitBtn = registerForm.querySelector('button[type="submit"]');
            registerForm.insertBefore(nextStepBtn, submitBtn);
            registerForm.insertBefore(prevStepBtn, submitBtn);

            // 隐藏提交按钮，直到最后一步
            submitBtn.style.display = 'none';

            // 创建用户信息摘要区域
            const userSummaryDiv = document.createElement('div');
            userSummaryDiv.className = 'user-summary';
            userSummaryDiv.style.display = 'none';
            registerForm.insertBefore(userSummaryDiv, registerForm.querySelector('.agreement'));

            // 添加测试填充按钮的事件监听
            const testFillBtn = document.getElementById('testFillBtn');
            if (testFillBtn) {
                testFillBtn.addEventListener('click', function () {
                    // 生成随机用户名 (user + 6位随机数)
                    const randomNum = Math.floor(Math.random() * 900000) + 100000;
                    const username = document.getElementById('username');
                    if (username) {
                        username.value = `user${randomNum}`;
                    }

                    // 生成随机手机号 (1开头的11位数字)
                    const phonePrefix = ['133', '135', '136', '137', '138', '139', '150', '151', '152', '157', '158', '159', '182', '183', '184', '187', '188', '198'];
                    const prefix = phonePrefix[Math.floor(Math.random() * phonePrefix.length)];
                    const suffix = String(Math.floor(Math.random() * 100000000)).padStart(8, '0');
                    const phone = registerForm.querySelector('input[type="tel"]');
                    if (phone) {
                        phone.value = `${prefix}${suffix}`;
                    }

                    // 设置验证码 (6位随机数)
                    const verificationCode = registerForm.querySelector('.verification-code input[pattern]');
                    if (verificationCode) {
                        verificationCode.value = String(Math.floor(Math.random() * 900000) + 100000);
                    }

                    // 设置密码 (包含数字和字母的8位以上密码)
                    const password = document.getElementById('password');
                    const confirmPassword = document.getElementById('confirmPassword');
                    const defaultPassword = `Test${randomNum}`;  // 例如：Test123456
                    if (password) {
                        password.value = defaultPassword;
                    }
                    if (confirmPassword) {
                        confirmPassword.value = defaultPassword;
                    }

                    // 添加动画效果
                    testFillBtn.style.backgroundColor = '#e8f5e9';
                    testFillBtn.style.borderColor = '#4caf50';
                    testFillBtn.style.color = '#4caf50';
                    testFillBtn.innerHTML = '<i class="fas fa-check"></i><span>填充完成</span>';

                    setTimeout(() => {
                        testFillBtn.style.backgroundColor = '#f0f0f0';
                        testFillBtn.style.borderColor = '#ccc';
                        testFillBtn.style.color = '#666';
                        testFillBtn.innerHTML = '<i class="fas fa-magic"></i><span>测试填充</span>';
                    }, 2000);
                });
            }

            // 添加身份信息测试填充按钮的事件监听
            const testFillIdentityBtn = document.getElementById('testFillIdentityBtn');
            if (testFillIdentityBtn) {
                testFillIdentityBtn.addEventListener('click', function () {
                    // 生成随机姓名（从常见姓氏和名字组合）
                    const surnames = ['张', '王', '李', '赵', '陈', '刘', '杨', '黄', '周', '吴'];
                    const names = ['伟', '芳', '娜', '秀英', '敏', '静', '丽', '强', '磊', '洋'];
                    const surname = surnames[Math.floor(Math.random() * surnames.length)];
                    const name = names[Math.floor(Math.random() * names.length)];
                    const fullName = surname + name;

                    const realName = document.getElementById('realName');
                    if (realName) {
                        realName.value = fullName;
                    }

                    // 生成随机身份证号码
                    function generateRandomIdCard() {
                        // 随机生成地区码（这里使用一些常见的地区码）
                        const areaCodes = ['110000', '310000', '440000', '510000', '330000'];
                        const areaCode = areaCodes[Math.floor(Math.random() * areaCodes.length)];

                        // 随机生成年份（1960-2000）
                        const year = Math.floor(Math.random() * (2000 - 1960 + 1)) + 1960;

                        // 随机生成月份（01-12）
                        const month = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');

                        // 随机生成日期（01-28，简化处理，避免处理大小月份）
                        const day = String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');

                        // 随机生成顺序码（3位）
                        const sequence = String(Math.floor(Math.random() * 999) + 1).padStart(3, '0');

                        // 前17位
                        const base = `${areaCode}${year}${month}${day}${sequence}`;

                        // 计算校验码
                        const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
                        const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];

                        let sum = 0;
                        for (let i = 0; i < 17; i++) {
                            sum += parseInt(base[i]) * weights[i];
                        }

                        const checkCode = checkCodes[sum % 11];

                        return base + checkCode;
                    }

                    const idCard = document.getElementById('idCard');
                    if (idCard) {
                        idCard.value = generateRandomIdCard();
                    }

                    // 添加动画效果
                    testFillIdentityBtn.style.backgroundColor = '#e8f5e9';
                    testFillIdentityBtn.style.borderColor = '#4caf50';
                    testFillIdentityBtn.style.color = '#4caf50';
                    testFillIdentityBtn.innerHTML = '<i class="fas fa-check"></i><span>填充完成</span>';

                    setTimeout(() => {
                        testFillIdentityBtn.style.backgroundColor = '#f0f0f0';
                        testFillIdentityBtn.style.borderColor = '#ccc';
                        testFillIdentityBtn.style.color = '#666';
                        testFillIdentityBtn.innerHTML = '<i class="fas fa-magic"></i><span>测试填充身份信息</span>';
                    }, 2000);
                });
            }

            // 下一步按钮点击事件
            nextStepBtn.addEventListener('click', function () {
                console.log('点击下一步按钮，当前步骤：', currentStep);
                if (validateCurrentStep()) {
                    console.log('验证通过，准备切换到下一步');
                    const nextStep = currentStep + 1;
                    console.log('即将切换到步骤：', nextStep);
                    showStep(nextStep);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    console.log('验证未通过');
                }
            });

            // 上一步按钮点击事件
            prevStepBtn.addEventListener('click', function () {
                showStep(currentStep - 1);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // 显示错误信息
            function showError(element, message) {
                if (!element) {
                    console.error('无法显示错误信息：元素不存在');
                    alert(message);
                    return;
                }

                // 获取或创建错误信息容器
                let errorDiv = element.parentElement.querySelector('.error-message');

                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                }

                // 设置错误信息样式
                errorDiv.textContent = message;
                errorDiv.style.color = '#f44336';
                errorDiv.style.fontSize = '12px';
                errorDiv.style.marginTop = '4px';

                // 获取表单组元素
                const formGroup = element.closest('.form-group');
                if (!formGroup) {
                    console.error('无法找到表单组元素');
                    alert(message);
                    return;
                }

                // 移除已存在的错误信息
                const existingError = formGroup.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }

                // 将错误信息添加到表单组的末尾
                formGroup.appendChild(errorDiv);

                // 设置输入框的错误状态样式
                element.style.borderColor = '#f44336';

                // 添加输入事件监听器，在用户开始输入时移除错误提示
                element.addEventListener('input', function () {
                    const error = formGroup.querySelector('.error-message');
                    if (error) {
                        error.remove();
                    }
                    this.style.borderColor = '';
                }, { once: true });
            }

            // 验证当前步骤
            function validateCurrentStep() {
                console.log('开始验证当前步骤：', currentStep);
                try {
                    if (currentStep === 0) {
                        // 基本信息验证保持不变
                        const username = document.getElementById('username');
                        const phone = registerForm.querySelector('input[type="tel"]');
                        const code = registerForm.querySelector('.verification-code input[pattern]');
                        const password = document.getElementById('password');
                        const confirmPassword = document.getElementById('confirmPassword');

                        // 验证用户名
                        if (!username || !username.value || username.value.length < 3) {
                            console.log('用户名验证失败');
                            showError(username, '用户名至少需要3个字符');
                            return false;
                        }

                        // 验证手机号
                        if (!phone || !phone.value || !/^1[3-9]\d{9}$/.test(phone.value)) {
                            console.log('手机号验证失败');
                            showError(phone, '请输入有效的手机号码');
                            return false;
                        }

                        // 验证验证码
                        if (!code || !code.value || !/^\d{6}$/.test(code.value)) {
                            console.log('验证码验证失败');
                            showError(code, '请输入6位验证码');
                            return false;
                        }

                        // 验证密码
                        if (!password || !password.value || password.value.length < 8) {
                            console.log('密码验证失败');
                            showError(password, '密码至少需要8个字符');
                            return false;
                        }

                        // 验证确认密码
                        if (!confirmPassword || !confirmPassword.value || password.value !== confirmPassword.value) {
                            console.log('确认密码验证失败');
                            showError(confirmPassword, '两次输入的密码不一致');
                            return false;
                        }

                        console.log('基本信息验证通过');
                        return true;

                    } else if (currentStep === 1) {
                        // 只验证身份信息：真实姓名、身份证号和用户角色
                        const realName = document.getElementById('realName');
                        const idCard = document.getElementById('idCard');
                        const roleSelector = document.getElementById('roleSelector');
                        const supplierChecked = document.getElementById('roleSupplier');
                        const buyerChecked = document.getElementById('roleBuyer');

                        console.log('验证身份信息字段');

                        // 验证真实姓名
                        if (!realName || !realName.value.trim()) {
                            console.log('真实姓名验证失败');
                            showError(realName, '请输入真实姓名');
                            return false;
                        }

                        // 验证身份证号码
                        if (!idCard || !idCard.value.trim()) {
                            console.log('身份证号码为空');
                            showError(idCard, '请输入身份证号码');
                            return false;
                        }

                        const idCardPattern = /^[1-9]\d{5}(18|19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[\dX]$/;
                        if (!idCardPattern.test(idCard.value)) {
                            console.log('身份证号码格式错误');
                            showError(idCard, '请输入正确的18位身份证号码');
                            return false;
                        }

                        // 验证用户角色（至少选择一个）
                        if (!supplierChecked || !buyerChecked || (!supplierChecked.checked && !buyerChecked.checked)) {
                            console.log('未选择用户角色');
                            const errorDiv = roleSelector.querySelector('.error-message') || roleSelector.nextElementSibling;
                            if (errorDiv) {
                                errorDiv.textContent = '请至少选择一个用户角色';
                                errorDiv.style.display = 'block';
                            } else {
                                showError(roleSelector, '请至少选择一个用户角色');
                            }
                            return false;
                        }

                        console.log('身份验证通过');
                        return true;
                    }

                    console.log('验证通过');
                    return true;
                } catch (error) {
                    console.error('验证过程中出错：', error);
                    return false;
                }
            }

            // 修改步骤切换函数
            function showStep(stepIndex) {
                console.log('开始切换步骤，目标步骤：', stepIndex);
                currentStep = stepIndex;

                // 更新步骤指示器
                steps.forEach((step, index) => {
                    if (index < stepIndex) {
                        step.classList.remove('active');
                        step.classList.add('completed');
                    } else if (index === stepIndex) {
                        step.classList.add('active');
                        step.classList.remove('completed');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });

                // 隐藏所有内容
                const formGroups = registerForm.querySelectorAll('.form-group');
                formGroups.forEach(group => group.style.display = 'none');

                const userSummary = registerForm.querySelector('.user-summary');
                const agreement = registerForm.querySelector('.agreement');

                if (userSummary) userSummary.style.display = 'none';
                if (agreement) agreement.style.display = 'none';

                document.querySelector('.supplier-info').style.display = 'none';
                document.querySelector('.buyer-info').style.display = 'none';

                console.log('切换到步骤：', stepIndex);

                if (stepIndex === 0) {
                    console.log('显示第一步：基本信息');
                    // 第一步：基本信息
                    const basicInfoGroups = Array.from(formGroups).slice(0, 5);
                    basicInfoGroups.forEach(group => group.style.display = 'block');
                    document.getElementById('testFillBtn').style.display = 'block';

                    nextStepBtn.textContent = '下一步：身份验证';
                    nextStepBtn.style.display = 'block';
                    prevStepBtn.style.display = 'none';
                    submitBtn.style.display = 'none';

                } else if (stepIndex === 1) {
                    console.log('显示第二步：身份验证');
                    // 第二步：身份验证
                    document.getElementById('testFillBtn').style.display = 'none';

                    // 只显示身份验证字段和角色选择
                    const identityFields = registerForm.querySelectorAll('.form-group:has(#realName), .form-group:has(#idCard), .form-group:has(#testFillIdentityBtn), .form-group:has(.role-selector)');
                    identityFields.forEach(field => {
                        field.style.display = 'block';
                        console.log('显示字段：', field);
                    });

                    nextStepBtn.textContent = '下一步：确认信息';
                    nextStepBtn.style.display = 'block';
                    prevStepBtn.style.display = 'block';
                    prevStepBtn.textContent = '返回基本信息';
                    submitBtn.style.display = 'none';

                } else if (stepIndex === 2) {
                    console.log('显示第三步：确认信息');
                    // 第三步：确认信息
                    document.getElementById('testFillBtn').style.display = 'none';

                    // 先创建用户信息摘要区域（如果不存在）
                    let summaryDiv = registerForm.querySelector('.user-summary');
                    if (!summaryDiv) {
                        console.log('创建用户信息摘要区域');
                        summaryDiv = document.createElement('div');
                        summaryDiv.className = 'user-summary';
                        registerForm.insertBefore(summaryDiv, registerForm.querySelector('.agreement'));
                    }

                    // 显示用户信息摘要和协议
                    summaryDiv.style.display = 'block';
                    if (agreement) {
                        agreement.style.display = 'flex';
                    }

                    // 更新用户信息摘要
                    console.log('更新用户信息摘要');
                    updateUserSummary();

                    nextStepBtn.style.display = 'none';
                    prevStepBtn.style.display = 'block';
                    prevStepBtn.textContent = '返回身份验证';
                    submitBtn.style.display = 'block';
                }

                console.log('步骤切换完成');
            }

            // 更新用户信息摘要函数
            function updateUserSummary() {
                try {
                    const username = document.getElementById('username').value;
                    const phone = registerForm.querySelector('input[type="tel"]').value;
                    const realName = document.getElementById('realName').value;
                    const idCard = document.getElementById('idCard').value;

                    // 获取选中的角色
                    const supplierChecked = document.getElementById('roleSupplier').checked;
                    const buyerChecked = document.getElementById('roleBuyer').checked;
                    let roleNames = [];
                    if (supplierChecked) roleNames.push('农产品供应商');
                    if (buyerChecked) roleNames.push('采购商');

                    let summaryDiv = registerForm.querySelector('.user-summary');
                    if (!summaryDiv) {
                        summaryDiv = document.createElement('div');
                        summaryDiv.className = 'user-summary';
                        registerForm.insertBefore(summaryDiv, registerForm.querySelector('.agreement'));
                    }

                    summaryDiv.innerHTML = `
                        <div class="summary-content" style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 15px 0; color: #333;">注册信息确认</h3>
                            <div style="line-height: 1.6;">
                                <p style="display: flex; justify-content: space-between; margin: 8px 0;">
                                    <span style="color: #666;">用户名：</span>
                                    <span style="font-weight: 500;">${username}</span>
                                </p>
                                <p style="display: flex; justify-content: space-between; margin: 8px 0;">
                                    <span style="color: #666;">手机号：</span>
                                    <span style="font-weight: 500;">${phone}</span>
                                </p>
                                <p style="display: flex; justify-content: space-between; margin: 8px 0;">
                                    <span style="color: #666;">真实姓名：</span>
                                    <span style="font-weight: 500;">${realName}</span>
                                </p>
                                <p style="display: flex; justify-content: space-between; margin: 8px 0;">
                                    <span style="color: #666;">身份证号：</span>
                                    <span style="font-weight: 500;">${idCard.replace(/(?<=\d{3})\d{11}(?=\d{4})/, '*'.repeat(11))}</span>
                                </p>
                                <p style="display: flex; justify-content: space-between; margin: 8px 0;">
                                    <span style="color: #666;">用户角色：</span>
                                    <span style="font-weight: 500;">${roleNames.join('、')}</span>
                                </p>
                            </div>
                        </div>
                        <p style="color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 20px;">
                            请仔细核对以上信息，确认无误后点击"完成注册"按钮完成账号创建。
                        </p>
                    `;
                } catch (error) {
                    console.error('更新用户信息摘要时出错：', error);
                }
            }

            // 注册表单提交事件
            registerForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                console.log('开始提交注册表单');

                try {
                    // 获取表单数据
                    const username = document.getElementById('username').value;
                    const phone = registerForm.querySelector('input[type="tel"]').value;
                    const password = document.getElementById('password').value;
                    const realName = document.getElementById('realName').value;
                    const idCard = document.getElementById('idCard').value;

                    // 获取用户角色
                    const roles = [];
                    if (document.getElementById('roleSupplier').checked) {
                        roles.push('supplier');
                    }
                    if (document.getElementById('roleBuyer').checked) {
                        roles.push('buyer');
                    }

                    // 构建注册数据
                    const registrationData = {
                        username,
                        phone,
                        password,
                        realName,
                        idCard,
                        roles,
                        defaultRole: roles[0] // 默认使用第一个角色
                    };

                    console.log('注册数据准备完成：', registrationData);

                    // 模拟注册请求
                    // TODO: 替换为实际的API调用
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // 注册成功后，保存用户信息到 localStorage
                    const userData = {
                        username,
                        phone,
                        realName,
                        roles,
                        currentRole: roles[0], // 设置默认角色
                        token: 'dummy_token_' + Math.random() // 模拟token，实际应该从后端获取
                    };

                    localStorage.setItem('userInfo', JSON.stringify(userData));
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userRole', roles[0]); // 设置默认角色

                    console.log('注册成功，已保存用户信息');

                    // 显示成功提示
                    alert('注册成功！正在为您跳转...');

                    // 直接跳转到首页
                    window.location.href = 'index.html';

                } catch (error) {
                    console.error('注册过程中出错：', error);
                    alert('注册失败，请重试');
                }
            });

            // 初始化显示第一步
            showStep(0);
        });
    </script>
</body>

</html>